# =============================================================================
# DocFlow: Extended Security Scanning
# =============================================================================
#
# PURPOSE:
# This workflow provides EXTENDED security scanning that complements the
# main CI pipeline (docflow-ci.yml). While CI handles fast, per-commit scans,
# this workflow provides deeper, scheduled security analysis.
#
# WHEN TO USE:
# - Scheduled weekly scans (runs Tuesday 8:30 AM UTC by default)
# - Manual deep-dive security audits
# - OWASP ZAP web application scanning
# - Full dependency audit with remediation guidance
#
# RELATIONSHIP TO CI PIPELINE:
# ┌────────────────────────────────────────────────────────────────────────┐
# │                     SECURITY SCANNING STRATEGY                         │
# ├─────────────────────────┬──────────────────────────────────────────────┤
# │  CI Pipeline (per-PR)   │  Extended Scan (weekly/manual)               │
# ├─────────────────────────┼──────────────────────────────────────────────┤
# │  TruffleHog (secrets)   │  TruffleHog (full history)                   │
# │  Trivy (quick SCA)      │  Trivy (comprehensive + container)           │
# │  Semgrep (SAST)         │  Semgrep (all rules + custom)                │
# │                         │  OWASP ZAP (DAST - web app testing)          │
# │                         │  CodeQL (deep semantic analysis)             │
# │                         │  License compliance checking                  │
# └─────────────────────────┴──────────────────────────────────────────────┘
#
# =============================================================================

name: "DocFlow: Extended Security Scan"

on:
  schedule:
    # Weekly full scan - Tuesday 8:30 AM UTC
    - cron: '30 8 * * 2'

  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - quick       # TruffleHog + Trivy only
          - full        # All scanners
          - dast        # OWASP ZAP only
          - compliance  # License + policy checks
      target_url:
        description: 'Target URL for OWASP ZAP (optional)'
        required: false
        type: string
      fail_on_findings:
        description: 'Fail build on security findings'
        required: false
        default: true
        type: boolean
      create_issues:
        description: 'Create GitHub issues for findings'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

env:
  SCAN_RESULTS_DIR: security-reports

jobs:
  # ===========================================================================
  # LAYER 1: Secret Scanning (Full History)
  # ===========================================================================
  secrets-full-scan:
    name: "Secrets (Full History)"
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'dast' && github.event.inputs.scan_type != 'compliance'
    timeout-minutes: 30
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: TruffleHog Deep Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --json --results=trufflehog-results.json
        continue-on-error: true

      - name: Generate Secret Report
        run: |
          mkdir -p $SCAN_RESULTS_DIR

          echo "# Secret Scan Results" > $SCAN_RESULTS_DIR/secrets-report.md
          echo "" >> $SCAN_RESULTS_DIR/secrets-report.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $SCAN_RESULTS_DIR/secrets-report.md
          echo "**Scan Type:** Full History" >> $SCAN_RESULTS_DIR/secrets-report.md
          echo "" >> $SCAN_RESULTS_DIR/secrets-report.md

          if [ -f "trufflehog-results.json" ]; then
            FINDINGS=$(cat trufflehog-results.json | jq -s 'length')
            echo "**Verified Secrets Found:** $FINDINGS" >> $SCAN_RESULTS_DIR/secrets-report.md

            if [ "$FINDINGS" -gt "0" ]; then
              echo "" >> $SCAN_RESULTS_DIR/secrets-report.md
              echo "## Findings" >> $SCAN_RESULTS_DIR/secrets-report.md
              echo "" >> $SCAN_RESULTS_DIR/secrets-report.md
              cat trufflehog-results.json | jq -r '.[].SourceMetadata.Data.Filesystem.file' 2>/dev/null | sort -u | head -20 >> $SCAN_RESULTS_DIR/secrets-report.md || true
            fi
          else
            echo "**Status:** No verified secrets found" >> $SCAN_RESULTS_DIR/secrets-report.md
          fi

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: secrets-full-scan
          path: ${{ env.SCAN_RESULTS_DIR }}/
          retention-days: 90

  # ===========================================================================
  # LAYER 2: Comprehensive SCA (Trivy)
  # ===========================================================================
  sca-comprehensive:
    name: "SCA (Comprehensive)"
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'dast' && github.event.inputs.scan_type != 'compliance'
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p $SCAN_RESULTS_DIR

      # Filesystem scan (dependencies)
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: '${{ env.SCAN_RESULTS_DIR }}/trivy-fs.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      # Container scan (if Dockerfile exists)
      - name: Check for Dockerfile
        id: dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build container for scanning
        if: steps.dockerfile.outputs.exists == 'true'
        run: docker build -t scan-target:latest . || true
        continue-on-error: true

      - name: Trivy Container Scan
        if: steps.dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'scan-target:latest'
          format: 'sarif'
          output: '${{ env.SCAN_RESULTS_DIR }}/trivy-container.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true

      # IaC scan (Terraform, CloudFormation, etc.)
      - name: Trivy IaC Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: '${{ env.SCAN_RESULTS_DIR }}/trivy-iac.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
        continue-on-error: true

      - name: Upload to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: '${{ env.SCAN_RESULTS_DIR }}'
          category: 'trivy-comprehensive'
        continue-on-error: true

      - name: Generate SCA Report
        run: |
          echo "# SCA Comprehensive Report" > $SCAN_RESULTS_DIR/sca-report.md
          echo "" >> $SCAN_RESULTS_DIR/sca-report.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $SCAN_RESULTS_DIR/sca-report.md
          echo "" >> $SCAN_RESULTS_DIR/sca-report.md
          echo "## Scans Performed" >> $SCAN_RESULTS_DIR/sca-report.md
          echo "- Filesystem (dependencies)" >> $SCAN_RESULTS_DIR/sca-report.md
          echo "- Container image: ${{ steps.dockerfile.outputs.exists }}" >> $SCAN_RESULTS_DIR/sca-report.md
          echo "- Infrastructure as Code" >> $SCAN_RESULTS_DIR/sca-report.md

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: sca-comprehensive
          path: ${{ env.SCAN_RESULTS_DIR }}/
          retention-days: 90

  # ===========================================================================
  # LAYER 3: CodeQL Deep Analysis
  # ===========================================================================
  codeql-analysis:
    name: "CodeQL Analysis"
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript', 'python']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect language applicability
        id: detect
        run: |
          case "${{ matrix.language }}" in
            javascript|typescript)
              if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | head -1 | grep -q .; then
                echo "applicable=true" >> $GITHUB_OUTPUT
              else
                echo "applicable=false" >> $GITHUB_OUTPUT
              fi
              ;;
            python)
              if find . -name "*.py" | head -1 | grep -q .; then
                echo "applicable=true" >> $GITHUB_OUTPUT
              else
                echo "applicable=false" >> $GITHUB_OUTPUT
              fi
              ;;
            *)
              echo "applicable=false" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Initialize CodeQL
        if: steps.detect.outputs.applicable == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        if: steps.detect.outputs.applicable == 'true'
        uses: github/codeql-action/autobuild@v4
        continue-on-error: true

      - name: Perform CodeQL Analysis
        if: steps.detect.outputs.applicable == 'true'
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"

  # ===========================================================================
  # LAYER 4: OWASP ZAP (DAST)
  # ===========================================================================
  owasp-zap-scan:
    name: "OWASP ZAP (${{ matrix.scan_type }})"
    runs-on: ubuntu-latest
    # Note: secrets cannot be checked at job level, so we check target_url and vars only
    # The step will check for secrets.PORTAL_URL as a fallback
    if: |
      (github.event.inputs.scan_type == 'full' ||
       github.event.inputs.scan_type == 'dast' ||
       github.event_name == 'schedule')
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        scan_type: [baseline, api]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Target URL
        id: target
        run: |
          if [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
            echo "has_target=true" >> $GITHUB_OUTPUT
          elif [ -n "${{ vars.PORTAL_URL }}" ]; then
            echo "url=${{ vars.PORTAL_URL }}" >> $GITHUB_OUTPUT
            echo "has_target=true" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.PORTAL_URL }}" ]; then
            echo "url=${{ secrets.PORTAL_URL }}" >> $GITHUB_OUTPUT
            echo "has_target=true" >> $GITHUB_OUTPUT
          else
            echo "has_target=false" >> $GITHUB_OUTPUT
            echo "No target URL configured"
          fi

      - name: ZAP Baseline Scan
        if: steps.target.outputs.has_target == 'true' && matrix.scan_type == 'baseline'
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ steps.target.outputs.url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      - name: Check for OpenAPI spec
        if: matrix.scan_type == 'api'
        id: openapi
        run: |
          for file in openapi.yaml openapi.yml openapi.json api/openapi.yaml swagger.yaml swagger.json; do
            if [ -f "$file" ]; then
              echo "spec=$file" >> $GITHUB_OUTPUT
              echo "has_spec=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "has_spec=false" >> $GITHUB_OUTPUT

      - name: ZAP API Scan
        if: steps.target.outputs.has_target == 'true' && matrix.scan_type == 'api' && steps.openapi.outputs.has_spec == 'true'
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: ${{ steps.target.outputs.url }}
          format: openapi
        continue-on-error: true

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-${{ matrix.scan_type }}-report
          path: report_*.html
          retention-days: 90
          if-no-files-found: ignore

  # ===========================================================================
  # LAYER 5: License Compliance
  # ===========================================================================
  license-check:
    name: "License Compliance"
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'compliance' || github.event.inputs.scan_type == 'full' || github.event_name == 'schedule'
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
        continue-on-error: true

      - name: Check NPM Licenses
        if: hashFiles('package.json') != ''
        run: |
          mkdir -p $SCAN_RESULTS_DIR
          npm ci 2>/dev/null || npm install 2>/dev/null || true
          npx license-checker --json > $SCAN_RESULTS_DIR/npm-licenses.json 2>/dev/null || true

          # Check for problematic licenses
          if [ -f "$SCAN_RESULTS_DIR/npm-licenses.json" ]; then
            echo "# License Compliance Report" > $SCAN_RESULTS_DIR/license-report.md
            echo "" >> $SCAN_RESULTS_DIR/license-report.md

            # Count licenses
            TOTAL=$(jq 'keys | length' $SCAN_RESULTS_DIR/npm-licenses.json)
            echo "**Total packages:** $TOTAL" >> $SCAN_RESULTS_DIR/license-report.md
            echo "" >> $SCAN_RESULTS_DIR/license-report.md

            # Check for GPL (might require code disclosure)
            GPL_COUNT=$(jq '[.[] | select(.licenses | test("GPL"; "i"))] | length' $SCAN_RESULTS_DIR/npm-licenses.json 2>/dev/null || echo "0")
            if [ "$GPL_COUNT" -gt "0" ]; then
              echo "**Warning:** $GPL_COUNT packages with GPL licenses" >> $SCAN_RESULTS_DIR/license-report.md
            fi

            # Check for unknown/unlicensed
            UNKNOWN=$(jq '[.[] | select(.licenses == "UNKNOWN" or .licenses == null)] | length' $SCAN_RESULTS_DIR/npm-licenses.json 2>/dev/null || echo "0")
            if [ "$UNKNOWN" -gt "0" ]; then
              echo "**Warning:** $UNKNOWN packages with unknown licenses" >> $SCAN_RESULTS_DIR/license-report.md
            fi
          fi
        continue-on-error: true

      - name: Check Python Licenses
        if: hashFiles('requirements.txt') != '' || hashFiles('pyproject.toml') != ''
        run: |
          pip install pip-licenses 2>/dev/null || true
          pip-licenses --format=json > $SCAN_RESULTS_DIR/python-licenses.json 2>/dev/null || true
        continue-on-error: true

      - name: Upload License Reports
        uses: actions/upload-artifact@v4
        with:
          name: license-compliance
          path: ${{ env.SCAN_RESULTS_DIR }}/
          retention-days: 90
          if-no-files-found: ignore

  # ===========================================================================
  # SUMMARY & REPORTING
  # ===========================================================================
  security-summary:
    name: "Security Summary"
    needs: [secrets-full-scan, sca-comprehensive, codeql-analysis, owasp-zap-scan, license-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports/
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "# Extended Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Type:** ${{ github.event.inputs.scan_type || 'scheduled' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning (Full) | ${{ needs.secrets-full-scan.result == 'success' && 'Pass' || needs.secrets-full-scan.result == 'skipped' && 'Skipped' || 'Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SCA (Comprehensive) | ${{ needs.sca-comprehensive.result == 'success' && 'Pass' || needs.sca-comprehensive.result == 'skipped' && 'Skipped' || 'Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result == 'success' && 'Pass' || needs.codeql-analysis.result == 'skipped' && 'Skipped' || 'Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP ZAP | ${{ needs.owasp-zap-scan.result == 'success' && 'Pass' || needs.owasp-zap-scan.result == 'skipped' && 'Skipped' || 'Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-check.result == 'success' && 'Pass' || needs.license-check.result == 'skipped' && 'Skipped' || 'Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download the scan reports from the workflow artifacts for detailed findings." >> $GITHUB_STEP_SUMMARY

      - name: Create Issue for Critical Findings
        if: github.event.inputs.create_issues == 'true' || github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if any scans failed
            const results = {
              secrets: '${{ needs.secrets-full-scan.result }}',
              sca: '${{ needs.sca-comprehensive.result }}',
              codeql: '${{ needs.codeql-analysis.result }}',
              zap: '${{ needs.owasp-zap-scan.result }}',
              license: '${{ needs.license-check.result }}'
            };

            const failures = Object.entries(results)
              .filter(([_, status]) => status === 'failure')
              .map(([name, _]) => name);

            if (failures.length > 0) {
              const title = `Security Scan Alert - ${new Date().toISOString().split('T')[0]}`;
              const body = `
            ## Extended Security Scan Results

            **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Triggered By:** ${{ github.event_name }}
            **Scan Type:** ${{ github.event.inputs.scan_type || 'scheduled' }}

            ### Scans Requiring Review

            ${failures.map(f => `- ${f}`).join('\n')}

            ### Action Required

            1. Download artifacts from the workflow run
            2. Review findings and assess severity
            3. Create remediation tasks as needed
            4. Close this issue when resolved

            ### All Results

            | Scan | Status |
            |------|--------|
            | Secrets | ${results.secrets} |
            | SCA | ${results.sca} |
            | CodeQL | ${results.codeql} |
            | OWASP ZAP | ${results.zap} |
            | License | ${results.license} |
            `;

              // Check for existing open issue
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'security,automated',
                state: 'open'
              });

              if (issues.length === 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['security', 'automated']
                });
              }
            }
        continue-on-error: true
